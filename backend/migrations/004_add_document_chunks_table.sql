-- =====================================================\n-- Migration: Add document_chunks table for global vector store tracking\n-- Date: September 28, 2025\n-- Purpose: Support single global vector store with chunk-level tracking\n-- =====================================================\n\nBEGIN;\n\n-- Create document_chunks table to track individual chunks in global vector store\nCREATE TABLE IF NOT EXISTS document_chunks (\n    id SERIAL PRIMARY KEY,\n    document_id INTEGER NOT NULL REFERENCES admin_documents(id) ON DELETE CASCADE,\n    chunk_index INTEGER NOT NULL,\n    chunk_text TEXT NOT NULL,\n    metadata JSONB,\n    vector_index INTEGER, -- Index position in FAISS vector store\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n    is_active BOOLEAN DEFAULT true\n);\n\n-- Create indexes for performance\nCREATE INDEX IF NOT EXISTS idx_document_chunks_document_id \n    ON document_chunks(document_id);\n    \nCREATE INDEX IF NOT EXISTS idx_document_chunks_active \n    ON document_chunks(document_id, is_active);\n    \nCREATE INDEX IF NOT EXISTS idx_document_chunks_vector_index \n    ON document_chunks(vector_index);\n    \nCREATE INDEX IF NOT EXISTS idx_document_chunks_chunk_index \n    ON document_chunks(document_id, chunk_index);\n\n-- Add comments for documentation\nCOMMENT ON TABLE document_chunks IS 'Tracks individual text chunks in the global vector store for admin documents';\nCOMMENT ON COLUMN document_chunks.document_id IS 'Reference to the source document';\nCOMMENT ON COLUMN document_chunks.chunk_index IS 'Index of this chunk within the document (0-based)';\nCOMMENT ON COLUMN document_chunks.chunk_text IS 'The actual text content of the chunk';\nCOMMENT ON COLUMN document_chunks.metadata IS 'JSONB metadata including page numbers, source info, etc.';\nCOMMENT ON COLUMN document_chunks.vector_index IS 'Position of this chunk in the FAISS vector store index';\nCOMMENT ON COLUMN document_chunks.is_active IS 'Whether this chunk is active in the current global vector store';\n\n-- Verify table creation\nSELECT \n    'document_chunks table created successfully' as status,\n    COUNT(*) as column_count\nFROM information_schema.columns \nWHERE table_name = 'document_chunks' AND table_schema = 'public';\n\n-- List all indexes on the new table\nSELECT \n    'Indexes created:' as info,\n    indexname,\n    indexdef\nFROM pg_indexes \nWHERE tablename = 'document_chunks' AND schemaname = 'public'\nORDER BY indexname;\n\nCOMMIT;\n\nSELECT 'ðŸŽ‰ Migration completed successfully! ðŸŽ‰' as result;\nSELECT 'The document_chunks table is ready for the new global vector store approach' as next_step;\n